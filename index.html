<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Asset Price Estimator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #ffffff; padding: 20px; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .btn-group .btn { margin-right: 5px; }
    .form-control, .btn { background-color: #1f1f1f; color: #ffffff; border: 1px solid #333; }
    .btn.active { background-color: #0d6efd; border-color: #0d6efd; }
    label { font-weight: 500; }
    #result, #resultSell, #stopLossResult { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; }
    .buy-result { color: #00ff88; }
    .sell-result { color: #ff5555; }
    .loss-result { color: #ff9900; }
    #tv-widget iframe, #price-ticker iframe { width: 100%; border: none; }
    #tv-widget iframe { height: 100px; }
    #price-ticker iframe { height: 50px; }
    .price-container { display: flex; align-items: center; gap: 10px; }
    .copy-btn { 
      padding: 2px 8px;
      font-size: 0.8rem;
      background-color: #333;
      border: 1px solid #555;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
    }
    .copy-btn:hover { background-color: #444; }
  </style>
</head>
<body>
  <div class="mb-2" id="price-ticker-container"><div id="price-ticker"></div></div>
  <div class="mb-4"><div id="tv-widget"></div></div>
  <h1 class="mb-4">價格估算器</h1>
  <fieldset class="mb-4">
    <legend class="form-label">選擇商品：</legend>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-light active" onclick="selectSymbol('xauusd', event)">XAUUSD</button>
      <button class="btn btn-outline-light" onclick="selectSymbol('solusd', event)">SOLUSD</button>
      <button class="btn btn-outline-light" onclick="selectSymbol('spx500', event)">SPX500</button>
    </div>
  </fieldset>

  <input type="hidden" id="symbol" value="xauusd">
  <div class="mb-3"><label for="balance" class="form-label">帳戶餘額 (USD)</label><input type="number" class="form-control" id="balance" value="1000" step="10" min="0"></div>
  <div class="mb-3"><label for="targetReturn" class="form-label">目標獲利百分比 (%)</label><input type="number" class="form-control" id="targetReturn" value="5" step="0.1" min="0"></div>
  <div class="mb-3"><label for="stopLossPercent" class="form-label">停損百分比 (相對於獲利)</label><input type="number" class="form-control" id="stopLossPercent" value="10" step="0.1" min="0"></div>
  <div class="mb-3"><label for="lot" class="form-label">Lot 數</label><input type="number" class="form-control" id="lot" step="0.01" value="0.05" min="0.01"></div>
  <div class="mb-3"><label for="entry" class="form-label">進場價格</label><input type="number" class="form-control" id="entry" step="0.01" value="0"></div>

  <p id="result" class="buy-result">多單計算結果：--</p>
  <p id="resultSell" class="sell-result">空單計算結果：--</p>
  <p id="stopLossResult" class="loss-result">停損結果：--</p>

  <script>
    const tradingViewSymbols = { xauusd: 'OANDA:XAUUSD', solusd: 'BINANCE:SOLUSDT', spx500: 'OANDA:SPX500USD' };

    function loadTradingView(symbolKey) {
      const container = document.getElementById('tv-widget');
      const script = document.createElement('script');
      container.innerHTML = '';
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
      script.type = 'text/javascript';
      script.async = true;
      script.text = JSON.stringify({ symbol: tradingViewSymbols[symbolKey], width: '100%', height: '100', locale: 'en', dateRange: '1D', colorTheme: 'dark', isTransparent: false, autosize: true });
      container.appendChild(script);
    }

    function loadPriceTicker(symbolKey) {
      const container = document.getElementById('price-ticker');
      const script = document.createElement('script');
      container.innerHTML = '';
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
      script.type = 'text/javascript';
      script.async = true;
      script.text = JSON.stringify({ symbols: [{ proName: tradingViewSymbols[symbolKey], title: symbolKey.toUpperCase() }], colorTheme: 'dark', isTransparent: false, displayMode: 'adaptive', locale: 'en' });
      container.appendChild(script);
    }

    function selectSymbol(symbol, e) {
      document.getElementById('symbol').value = symbol;
      document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      loadTradingView(symbol);
      loadPriceTicker(symbol);
      resetFields(symbol);
      calculateAll();
    }

    function resetFields(symbol) {
      const lotField = document.getElementById('lot');
      lotField.min = symbol === 'xauusd' ? 0.01 : 0.1;
      lotField.step = symbol === 'xauusd' ? 0.01 : 0.1;
      lotField.value = symbol === 'xauusd' ? 0.05 : 0.1;
      document.getElementById('entry').step = symbol === 'spx500' ? 1 : 0.01;
      document.getElementById('entry').value = 0;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).catch(err => {
        console.error('複製失敗:', err);
      });
    }

    function calculateAll() {
      const entry = parseFloat(document.getElementById('entry').value) || 0;
      const lot = parseFloat(document.getElementById('lot').value) || 0;
      const balance = parseFloat(document.getElementById('balance').value) || 0;
      const pct = parseFloat(document.getElementById('targetReturn').value) || 0;
      const stopPct = parseFloat(document.getElementById('stopLossPercent').value) || 0;
      const sym = document.getElementById('symbol').value;

      let pipSize = sym === 'spx500' ? 1 : 0.01;
      let pipVal = sym === 'solusd' ? 0.1 : (sym === 'spx500' ? 10 : 1);

      const targetProfit = balance * pct / 100;
      const pipsNeeded = targetProfit / (pipVal * lot);
      const priceDiff = pipsNeeded * pipSize;

      const exitLong = entry + priceDiff;
      const exitShort = entry - priceDiff;

      const stopLossAmount = targetProfit * (stopPct / 100);
      const stopPips = stopLossAmount / (pipVal * lot);
      const stopDiff = stopPips * pipSize;

      const stopLong = entry - stopDiff;
      const stopShort = entry + stopDiff;

      document.getElementById('result').innerHTML = `
        多單計算結果：
        <div class="price-container">
          <span>目標出場價：${exitLong.toFixed(2)}</span>
          <button class="copy-btn" onclick="copyToClipboard('${exitLong.toFixed(2)}')">複製</button>
          <span>| 盈虧：${targetProfit.toFixed(2)} USD</span>
        </div>`;

      document.getElementById('resultSell').innerHTML = `
        空單計算結果：
        <div class="price-container">
          <span>目標出場價：${exitShort.toFixed(2)}</span>
          <button class="copy-btn" onclick="copyToClipboard('${exitShort.toFixed(2)}')">複製</button>
          <span>| 盈虧：${targetProfit.toFixed(2)} USD</span>
        </div>`;

      document.getElementById('stopLossResult').innerHTML = `
        停損結果：
        <div class="price-container">
          <span>停損價（多單）：${stopLong.toFixed(2)}</span>
          <button class="copy-btn" onclick="copyToClipboard('${stopLong.toFixed(2)}')">複製</button>
          <span>| 停損價（空單）：${stopShort.toFixed(2)}</span>
          <button class="copy-btn" onclick="copyToClipboard('${stopShort.toFixed(2)}')">複製</button>
          <span>| 預估損失：${stopLossAmount.toFixed(2)} USD</span>
        </div>`;
    }

    window.onload = () => {
      ['entry','lot','balance','targetReturn','stopLossPercent'].forEach(id => document.getElementById(id).addEventListener('input', calculateAll));
      selectSymbol('xauusd', { target: document.querySelector('.btn-group .btn') });
    };
  </script>
</body>
</html>
